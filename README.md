# NFS on PSP custom music toolkit

Helps with adding/removing/editing music tracks for some Need for Speed games on the PlayStation Portable.

Track info editing works with NFS Underground Rivals without issues (just replace `trackinfo` file). It also works with other games using the same engine (NFS Most Wanted, NFS Carbon, NFS ProStreet and NFS Undercover) but it's very tricky (see below).
May work on other games that have soundtracks as ATRAC3plus audio in a RIFF WAVE container.

NFS: MW, Carbon, ProStreet and UC all have `trackinfo` files on the disc, but it's completely unused in the finished game. Perhaps it's a leftover from development.

The toolkit isn't complete:
* It needs FFmpeg to analyze audio files and convert them to .wav if necessary. [Instructions how to install FFmpeg on Windows](https://www.wikihow.com/Install-FFmpeg-on-Windows).
* To encode new tracks or replace existing tracks you need UMD Stream Composer. It's a proprietary tool, but you can find it quite easily.
* You will also need UMDGen to unpack/edit UMD ISO files: [link 1](https://www.romhacking.net/utilities/1218/) or [link 2](https://www.psx-place.com/threads/umd-gen-4-00.10340/).

# Functions
* converts "trackinfo" file into a CSV file for editing
* converts a CSV file into "trackinfo" file
* converts any music file compatible with FFmpeg into .wav file for use with UMD Stream Composer
    * This also gives the file a name with extra data that will be used later after conversion to .atx
* converts .atx file generated by UMD Stream Composer into a .aud file that can be played by the game
* "generate" visualization data for an .aud file
    * for now this simply copies and renames a file from the original game
    * this is just to keep playback in game's track browser from glitching

# Workflow
Below I will explain how to add more tracks to your current game:
* Make a folder and put `toolkit.py` and any new audio tracks you want to convert. You might want to rename them to something short and without spaces.
* Drag and drop your music tracks into `toolkit.py`. They will be converted into specially named .wav files.
    1. Create a new project. Put anything you want as project name and put the name of the .wav file you want to convert as the clip name.
    2. Check the "PSP Movie Format" checkbox. Set "Video Stream" to 0.
    3. Drag and drop the .wav file into the timeline
    4. (optional) Click "Audio Enc Settings" and change bitrate to whatever you want. Default is 128 kbps and it gives okay quality.
    5. (if you have more than one file) Click on "New" to add another file to your project. Put the name of the .wav file you want to convert as the clip name, then repeat steps 2-4.
    6. Click on Run, then Encode. All files you added to the project will be encoded in sequence.
    7. Open My Documents -> UmdStreamComposer -> EncWork -> `<project name>` and take out all the .atx files from the subfolders. They should all have the same name as the .wav files on the input, but with `_Audio1` at the end.
    8. Move the encoded .atx files to the same folder as your `toolkit.py`
* Drag and drop .atx files onto `toolkit.py` to convert them to .aud files
* Use UMDGen to unpack any .dat file from `eavis/dat` folder.
* Rename the .dat file to `!!example_vis.dat` and put it in the same folder as your .aud files.
* Drag and drop .aud files onto `toolkit.py` to make (fake) visualization files for them.
* Use UMDGen to unpack `trackinfo` file from the `eatrax` folder.
* Drag and drop `trackinfo` onto `toolkit.py` to generate a CSV file.
* Open the CSV file in Excel (or alternative) to edit it easily. It can also be modified in Notepad but it's kind of a pain.
  * In the `filename_base` column input the name of your .aud file, but without .aud extension
  * `have_video` column can be left blank, it defaults to False
* After saving the CSV file, drag and drop it into `toolkit.py` to convert it back into a binary format. Rename the resulting file to just `trackinfo`.
* Use UMDGen to replace the original `trackinfo` file, put all new .aud files into `eatrax` folder, put all new .dat files into `eavis/dat` folder, remove unused .aud and .dat files.
    * After doing your changes save the resulting file to ISO or CSO file

# Notes on UMD Stream Composer
The tool is very old and proprietary, so there are no updates available. It requires .NET Framework 1.1 to run, which is not supported on Windows 10 and seems to not work too well on Windows 7. Nowadays the only sensible way to run it is to do it in a Windows XP virtual machine. After installing Windows XP on a VM you have to install .NET Framework 1.1, otherwise you'll get a warning about missing .dll files. You may get a warning about DirectDraw device not supporting overlays. This is okay and the application should run despite this. If your program crashes after displaying this message, the DirectDraw device is not the problem.

# Notes on encoding into ATRAC3plus
Music tracks have to be encoded into ATRAC3plus, not just ATRAC3 - and in some sort of specific way that the PSP can play.

Encoding them into ATRAC3 **will work on an emulator** (specifically PPSSPP). In fact, simply renaming a regular PCM .wav file to .aud will work on that emulator. However, on a real console only converting to ATRAC3plus will work correctly.

You may have limited success with playback of ATRAC3 files on a real console but in my experience they tend to randomly crash the game. Some songs can play in their entirety, others crash halfway through or crash immediately. Only encoding with the method I described works flawlessly.

I looked for alternatives to UMD Stream Composer, but there don't seem to be any that do the necessary thing:
* [Sony SonicStage](https://archive.org/details/jp.sony.omgjbox) can convert files into ATRAC3plus, but the are in OMA container. `toolkit.py` contains an experimental function that converts .oma files to .aud, but the resulting files don't play on real hardware.
* nâ€¢code by [Sonic Studio](https://sonicstudio.com/) can encode ATRAC3plus. But it is (was?) a proprietary tool, supposedly expensive. It might be lost to history, all I could find of it is a [PDF manual](https://www.sonicstudio.com/pdf/ncode/ncode_UserManual10.pdf) and [some web captures from 2004](http://web.archive.org/web/20040803015139/http://sonicstudio.com/products_ncode.htm).
* There is an ACM codec for encoding into ATRAC3, but not ATRAC3plus. It works nicely for making custom tracks for GTA LCS/VCS on the PSP though.

# `trackinfo` replacement in later games
In these games the `trackinfo` stored directly in the ISO is not used. The file which is actually used sits packed and compressed inside `bundle/bootbundle.viv` file. The contents of these .viv files are loaded as an "overlay" over the actual files on the disc. I'm still working on some reasonable way to modify the file.

## Proof-of-concept implementation in NFS Carbon
* Use [Watto Game Extractor](http://www.watto.org/game_extractor.html) (free version) to unpack `bootbundle.viv` into a folder.
    * The extractor will decompress it into `bootbundle_ge_decompressed.viv`, then complain that "No plugins were able to open the archive".
    * Open `bootbundle_ge_decompressed.viv`, it should work just fine.
* Once you extract all the files into a folder, use UMDGen to paste them over the original folder structure, replacing any files if necessary.
* Extract `be_to_febundle.viv`, rename it to `bootbundle.viv` and copy it over the original file.
* Now you can replace `trackinfo` and any other files from `bootbundle.viv` if you want.

Unlike NFS Underground Rivals, Carbon may crap itself if you already have a savegame with a different number of songs.

## Observations so far
* .viv files can be decompressed, but I haven't found a free utility that can compress them again.
* Compression scheme is probably *not* Refpack.
* Decompressed .viv files are in EA BIGF format.
* `bootbundle.viv` *must* be compressed, otherwise the game crashes trying to load it.
* Contents of .viv files can be unpacked into the ISO and the game will run just fine reading "unbundled" files.
* Modifying the game's code is another way of circumventing this overlay. You can change a string in the game's code to, say, `trackinf` and put a `trackinf` file into the ISO. The problem is that the game's executable must be decrypted for the modification and a real PSP will refuse to run unencrypted executable files.

# Why?
I ask myself that question every day.